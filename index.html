<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Reaction Challenge - Anti-Cheat</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --primary-color: #2ed573;
            --secondary-color: #ff4757;
            --bg-color: #f0f2f5;
            --text-color: #2f3542;
            --card-bg: #ffffff;
            --penalty-color: #ff6b81;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px 10px;
            box-sizing: border-box;
            user-select: none; /* é˜²æ­¢é€£é»é¸å–æ–‡å­— */
        }

        h1, h2, h3 {
            margin: 0.5em 0;
            text-align: center;
        }

        .main-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 480px;
        }

        .status-bar {
            margin-bottom: 15px;
            font-size: 1.3rem;
            font-weight: bold;
            color: #57606f;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
        }

        /* 9å®®æ ¼å®¹å™¨ */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            background-color: #dfe4ea;
            padding: 15px;
            border-radius: 16px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.08);
            width: 100%;
            max-width: 360px;
            aspect-ratio: 1 / 1;
            margin-bottom: 20px;
            transition: background-color 0.2s;
        }

        /* çŠ¯è¦æ™‚èƒŒæ™¯é–ƒçˆç´…è‰² */
        .grid-container.penalty-flash {
            background-color: var(--penalty-color);
            animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both;
        }

        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        /* å–®å€‹æ ¼å­ */
        .cell {
            background-color: var(--card-bg);
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.1s, background-color 0.15s;
            aspect-ratio: 1 / 1;
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-tap-highlight-color: transparent;
        }

        .cell:active { transform: scale(0.92); }

        .cell.active {
            background-color: var(--secondary-color);
            box-shadow: 0 0 20px rgba(255, 71, 87, 0.7);
            border: 2px solid #fff;
        }

        .controls {
            width: 100%;
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 30px;
            font-size: 1.1rem;
            font-weight: bold;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        #start-btn { background-color: var(--primary-color); color: white; }
        #start-btn:hover { background-color: #26af61; transform: translateY(-2px); }
        #start-btn:disabled { background-color: #ccc; cursor: not-allowed; transform: none; box-shadow: none;}

        #screenshot-btn {
            background-color: #3742fa;
            color: white;
            margin-top: 20px;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
            width: 100%;
            max-width: 300px;
        }
        #screenshot-btn:hover { background-color: #2f3542; }

        #capture-area {
            width: 100%;
            box-sizing: border-box; 
            padding: 20px;
            background-color: var(--bg-color); 
            border-radius: 10px;
        }

        .results-container {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 20px;
        }

        #current-result-board { display: none; }

        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f1f2f6;
            font-feature-settings: "tnum";
        }

        .result-item.excluded {
            color: #b2bec3;
            text-decoration: line-through;
            font-size: 0.9em;
        }

        .result-item.penalty-text {
            color: var(--secondary-color);
            font-weight: bold;
        }
        
        .average-score-box {
            margin-top: 15px;
            padding: 15px;
            background-color: #f1f2f6;
            border-radius: 10px;
            text-align: center;
        }
        .average-score-box strong { color: var(--secondary-color); font-size: 1.5em; }
        .average-note { font-size: 0.8rem; color: #747d8c; margin-top: 5px; }

        .leaderboard-list { list-style: none; padding: 0; margin: 0; }
        
        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 5px;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
        }

        .rank-num { font-weight: bold; width: 30px; color: #747d8c; }
        .rank-1 .rank-num { color: #ffd32a; font-size: 1.1em; }
        .rank-2 .rank-num { color: #d2d6de; font-size: 1.05em; }
        .rank-3 .rank-num { color: #ff7f50; font-size: 1.05em; }

        .rank-time { font-weight: bold; color: var(--text-color); }
        .rank-date { font-size: 0.75rem; color: #a4b0be; }

    </style>
</head>
<body>

<div class="main-container">
    <h1>âš¡ åæ‡‰åŠ›æŒ‘æˆ° âš¡</h1>
    
    <div class="status-bar" id="status-text">æº–å‚™å¥½äº†å—ï¼Ÿ</div>

    <div class="grid-container" id="grid"></div>

    <div class="controls">
        <button id="start-btn" class="btn" onclick="startGame()">é–‹å§‹æ¸¬è©¦</button>
    </div>
    <div class="name-row" style="margin-bottom:12px;width:100%;max-width:360px;display:flex;gap:8px;">
        <input id="player-name" placeholder="æš±ç¨±(é¸å¡«)" maxlength="16" style="flex:1;padding:10px 14px;border:1px solid #ccc;border-radius:8px;font-size:0.95rem;">
        <button id="save-last" class="btn" style="background:#ff9f43;white-space:nowrap;" disabled>ä¿å­˜æˆç¸¾</button>
    </div>

    <div id="capture-area">
        <div id="current-result-board" class="results-container">
            <h3>æœ¬æ¬¡æ¸¬è©¦çµæœ</h3>
            <div id="result-list"></div>
            <div class="average-score-box" id="average-score"></div>
        </div>

        <div id="leaderboard-board" class="results-container">
            <h3>ğŸ† æ­·å² TOP 10</h3>
            <ul id="leaderboard-list" class="leaderboard-list"></ul>
        </div>
        
        <div style="text-align: center; font-size: 0.8rem; color: #999; margin-top: 10px;">
            Challenge your reaction speed!
        </div>
    </div>

    <button id="screenshot-btn" class="btn" style="display: none;" onclick="takeScreenshot()">
        ğŸ“¸ æˆªåœ–æˆç¸¾å–® (è¤‡è£½åˆ°å‰ªè²¼ç°¿)
    </button>
</div>

<script>
    // --- è®Šæ•¸èˆ‡ DOM ---
    const gridContainer = document.getElementById('grid');
    const statusText = document.getElementById('status-text');
    const startBtn = document.getElementById('start-btn');
    const currentResultBoard = document.getElementById('current-result-board');
    const resultList = document.getElementById('result-list');
    const averageScoreDiv = document.getElementById('average-score');
    const leaderboardList = document.getElementById('leaderboard-list');
    const screenshotBtn = document.getElementById('screenshot-btn');
    const captureArea = document.getElementById('capture-area');

    const TOTAL_ROUNDS = 7;
    let currentRound = 0;
    let reactionTimes = [];
    let startTime = 0;
    
    // éŠæˆ²éšæ®µç‹€æ…‹ç®¡ç†
    // 'idle': é–’ç½®ä¸­
    // 'waiting': ç­‰å¾…äº®ç‡ˆ (æ­¤æ™‚é»æ“Š = å·è·‘)
    // 'active': ç‡ˆå·²äº® (æ­¤æ™‚é»æ“Š = ç´€éŒ„æˆç¸¾)
    // 'processing': æ­£åœ¨è™•ç†è½‰å ´ (é˜²æ­¢é€£é»)
    let gamePhase = 'idle'; 
    
    let activeCellIndex = -1;
    let timer = null;
    const STORAGE_KEY = 'reaction_game_scores_v3_penalty'; // æ›´æ–° Key

    // --- åˆå§‹åŒ– ---
    function init() {
        initGrid();
        renderLeaderboard();
    }

    function initGrid() {
        gridContainer.innerHTML = '';
        for (let i = 0; i < 9; i++) {
            let cell = document.createElement('div');
            cell.classList.add('cell');
            // æ”¹ç”¨ pointerdown ä»¥æ±‚æœ€å¿«åæ‡‰
            cell.addEventListener('pointerdown', (e) => {
                e.preventDefault(); 
                handleCellClick(i);
            });
            gridContainer.appendChild(cell);
        }
    }

    // --- éŠæˆ²é‚è¼¯ ---
    function startGame() {
        currentRound = 0;
        reactionTimes = [];
        startBtn.disabled = true;
        startBtn.textContent = "æ¸¬è©¦é€²è¡Œä¸­...";
        currentResultBoard.style.display = 'none';
        screenshotBtn.style.display = 'none';
        
        document.querySelectorAll('.cell').forEach(c => c.classList.remove('active'));
        nextRound();
    }

    function nextRound() {
        if (currentRound >= TOTAL_ROUNDS) {
            endGame();
            return;
        }
        currentRound++;
        statusText.innerHTML = `<span style="color:#747d8c">Round ${currentRound}/${TOTAL_ROUNDS}</span> - ç­‰å¾…äº®ç‡ˆ...`;
        
        // é€²å…¥ç­‰å¾…éšæ®µ (å·è·‘åµæ¸¬é–‹å§‹)
        gamePhase = 'waiting';
        document.querySelectorAll('.cell').forEach(c => c.classList.remove('active'));

        const randomDelay = Math.floor(Math.random() * 1700) + 800; // 0.8s - 2.5s
        timer = setTimeout(activateRandomCell, randomDelay);
    }

    function activateRandomCell() {
        // å¦‚æœç‹€æ…‹ä¸æ˜¯ waiting (å¯èƒ½å·²ç¶“å› ç‚ºå·è·‘è¢«å–æ¶ˆ)ï¼Œå‰‡ä¸åŸ·è¡Œ
        if (gamePhase !== 'waiting') return;

        const cells = document.querySelectorAll('.cell');
        let randomIndex;
        do { randomIndex = Math.floor(Math.random() * 9); } 
        while (randomIndex === activeCellIndex && Math.random() > 0.5);
        
        activeCellIndex = randomIndex;
        cells[randomIndex].classList.add('active');
        
        startTime = performance.now();
        gamePhase = 'active'; // é€²å…¥æ´»èºéšæ®µ (å¯ä»¥é»æ“Š)
        statusText.innerHTML = `<span style="color: var(--secondary-color)">ğŸ”¥ å¿«æŒ‰! ğŸ”¥</span>`;
    }

    function handleCellClick(index) {
        // 1. å·è·‘åˆ¤æ–· (Waiting éšæ®µé»æ“Šä»»æ„æ ¼å­)
        if (gamePhase === 'waiting') {
            triggerPenalty();
            return;
        }

        // 2. æ­£å¸¸é»æ“Šåˆ¤æ–· (Active éšæ®µé»æ“Šæ­£ç¢ºæ ¼å­)
        if (gamePhase === 'active') {
            if (index === activeCellIndex) {
                const endTime = performance.now();
                const reactionTime = Math.round(endTime - startTime);
                recordSuccess(reactionTime);
            }
        }
        
        // å¦‚æœæ˜¯ Active éšæ®µä½†é»éŒ¯æ ¼å­? 
        // ä¾æ“šé€šå¸¸æ…£ä¾‹ï¼Œé€™è£¡ä¸åšåæ‡‰ï¼Œç›´åˆ°é»å°ç‚ºæ­¢ã€‚
        // è‹¥è¦æ›´åŠ åš´æ ¼ï¼Œä¹Ÿå¯ä»¥åœ¨é€™è£¡åŠ å…¥æ‡²ç½°ï¼Œä½†ç›®å‰é¡Œç›®åƒ…è¦æ±‚ "é åˆ¤(å·è·‘)" æ©Ÿåˆ¶ã€‚
    }

    // è§¸ç™¼å·è·‘æ‡²ç½°
    function triggerPenalty() {
        clearTimeout(timer); // æ¸…é™¤åŸæœ¬è¦äº®ç‡ˆçš„è¨ˆæ™‚å™¨
        gamePhase = 'processing'; // é–å®šç‹€æ…‹é˜²æ­¢é€£é»

        // è¦–è¦ºå›é¥‹
        gridContainer.classList.add('penalty-flash');
        setTimeout(() => gridContainer.classList.remove('penalty-flash'), 400);

        // ç´€éŒ„ 1000ms
        const penaltyTime = 1000;
        reactionTimes.push(penaltyTime);
        
        statusText.innerHTML = `<span style="color: var(--secondary-color)">ğŸš« å·è·‘çŠ¯è¦! (+1000ms)</span>`;
        
        // å»¶é²å¾Œé€²å…¥ä¸‹ä¸€å±€
        setTimeout(nextRound, 1000);
    }

    // ç´€éŒ„æˆåŠŸé»æ“Š
    function recordSuccess(time) {
        gamePhase = 'processing'; // é–å®š
        reactionTimes.push(time);
        
        document.querySelectorAll('.cell')[activeCellIndex].classList.remove('active');
        statusText.textContent = `${time} ms`;
        
        setTimeout(nextRound, 400);
    }

    function endGame() {
        gamePhase = 'idle';
        startBtn.disabled = false;
        startBtn.textContent = "å†æ¬¡æŒ‘æˆ°";
        statusText.innerHTML = "ğŸ‰ æ¸¬è©¦å®Œæˆ!";
        showCurrentResults();
        saveAndUpdateLeaderboard();
        screenshotBtn.style.display = 'flex';
        currentResultBoard.scrollIntoView({ behavior: 'smooth', block: 'start' });
        document.getElementById('save-last').disabled = false;
    }

    // --- è¨ˆç®—é‚è¼¯: å»é ­å»å°¾å¹³å‡ ---
    function calculateTrimmedScore(times) {
        if (times.length < 3) return { avg: 0, minIdx: -1, maxIdx: -1 };
        
        let minVal = Math.min(...times);
        let maxVal = Math.max(...times);
        
        let minIdx = times.indexOf(minVal);
        let maxIdx = times.indexOf(maxVal);

        let sorted = [...times].sort((a, b) => a - b);
        let trimmed = sorted.slice(1, sorted.length - 1);
        let total = trimmed.reduce((a, b) => a + b, 0);
        let avg = Math.round(total / trimmed.length);

        return { avg, minIdx, maxIdx };
    }

    function showCurrentResults() {
        currentResultBoard.style.display = 'block';
        resultList.innerHTML = '';
        
        const { avg, minIdx, maxIdx } = calculateTrimmedScore(reactionTimes);

        reactionTimes.forEach((time, index) => {
            const item = document.createElement('div');
            item.classList.add('result-item');
            
            let isPenalty = (time === 1000); // ç°¡å–®åˆ¤æ–·æ˜¯å¦ç‚ºæ‡²ç½°åˆ†æ•¸
            
            let isExcluded = (index === minIdx || index === maxIdx);
            if (isExcluded) item.classList.add('excluded');
            if (isPenalty) item.classList.add('penalty-text');

            let roundText = `Round ${index + 1}`;
            if (isExcluded) {
                if (index === minIdx) roundText += " (æœ€å¿«)";
                if (index === maxIdx) roundText += " (æœ€æ…¢)";
            }
            
            let timeText = `${time} ms`;
            if (isPenalty) timeText += " (å·è·‘)";

            item.innerHTML = `<span>${roundText}</span> <span>${timeText}</span>`;
            resultList.appendChild(item);
        });

        averageScoreDiv.innerHTML = `
            å¹³å‡åæ‡‰æ™‚é–“<br>
            <strong>${avg} ms</strong>
            <div class="average-note">(å»é™¤æœ€å¿«èˆ‡æœ€æ…¢æˆç¸¾)</div>
        `;
    }

    // --- æ’è¡Œæ¦œ (LocalStorage) ---
    function formatDateTime(timestamp) {
        const date = new Date(timestamp);
        return date.toLocaleString('zh-TW', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false });
    }

    function saveAndUpdateLeaderboard() {
        const { avg } = calculateTrimmedScore(reactionTimes);
        
        const newScore = { avgTime: avg, timestamp: new Date().getTime() };
        let scores = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        scores.push(newScore);
        scores.sort((a, b) => a.avgTime - b.avgTime);
        scores = scores.slice(0, 10);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(scores));
        renderLeaderboard();
    }

    function renderLeaderboard() {
        const scores = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        leaderboardList.innerHTML = '';
        if (scores.length === 0) {
            leaderboardList.innerHTML = '<li style="text-align:center; padding:10px; color:#999;">å°šç„¡ç´€éŒ„ï¼Œå¿«ä¾†æŒ‘æˆ°!</li>';
            return;
        }
        scores.forEach((score, index) => {
            const li = document.createElement('li');
            li.classList.add('leaderboard-item', `rank-${index + 1}`);
            li.innerHTML = `
                <div style="display:flex; align-items:center;">
                    <span class="rank-num">${index + 1}.</span>
                    <span class="rank-time">${score.avgTime} ms</span>
                </div>
                <span class="rank-date">${formatDateTime(score.timestamp)}</span>
            `;
            leaderboardList.appendChild(li);
        });
    }

    // --- æˆªåœ–åŠŸèƒ½ ---
    async function takeScreenshot() {
        const originalBtnText = screenshotBtn.innerHTML;
        screenshotBtn.innerHTML = 'â³ è™•ç†ä¸­...';
        screenshotBtn.disabled = true;

        try {
            const canvas = await html2canvas(captureArea, {
                scale: 2, 
                backgroundColor: '#f0f2f5', 
                useCORS: true,
                width: captureArea.scrollWidth, 
                height: captureArea.scrollHeight
            });

            canvas.toBlob(async (blob) => {
                if (!blob) throw new Error('Canvas Error');
                
                if (navigator.clipboard && navigator.clipboard.write) {
                    try {
                        const item = new ClipboardItem({ 'image/png': blob });
                        await navigator.clipboard.write([item]);
                        screenshotBtn.innerHTML = 'âœ… å·²è¤‡è£½!';
                    } catch (err) {
                        fallbackDownload(canvas);
                    }
                } else {
                    fallbackDownload(canvas);
                }
                
                setTimeout(() => {
                    screenshotBtn.innerHTML = originalBtnText;
                    screenshotBtn.disabled = false;
                }, 3000);

            }, 'image/png');

        } catch (err) {
            console.error('Screenshot failed:', err);
            screenshotBtn.innerHTML = 'âŒ å¤±æ•—';
            screenshotBtn.disabled = false;
        }
    }

    function fallbackDownload(canvas) {
        const link = document.createElement('a');
        link.download = `åæ‡‰åŠ›æˆç¸¾_${new Date().getTime()}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
        screenshotBtn.innerHTML = 'âœ… å·²ä¸‹è¼‰åœ–ç‰‡';
    }

    // --- Firebase Integration (added) ---
    let firebaseDatabase = null;
    let firebaseInitialized = false;
    async function initFirebase(){
        try {
            const appModule = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
            const dbModule = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js');
            const firebaseConfig = {
              apiKey: "AIzaSyDLApbv6qovIYaGr9lifLLNn1Hxc288JJM",
              authDomain: "snake-5dfac.firebaseapp.com",
              projectId: "snake-5dfac",
              storageBucket: "snake-5dfac.firebasestorage.app",
              messagingSenderId: "480046494846",
              appId: "1:480046494846:web:4ecb40f4495963dcc6b42f",
              measurementId: "G-E51iFME9ZX",
              databaseURL: "https://snake-5dfac-default-rtdb.asia-southeast1.firebasedatabase.app"
            };
            const app = appModule.initializeApp(firebaseConfig);
            firebaseDatabase = dbModule.getDatabase(app);
            firebaseInitialized = true;
            subscribeFirebaseLeaderboard(dbModule);
        } catch (e){
            console.warn('Firebase init failed or DB not enabled', e);
        }
    }
    function subscribeFirebaseLeaderboard(dbModule){
        const { ref, query, orderByChild, limitToFirst, onValue } = dbModule;
        if(!firebaseDatabase) return;
        const scoresQuery = query(ref(firebaseDatabase,'reactionScores'), orderByChild('avgTime'), limitToFirst(10));
        onValue(scoresQuery, snap => {
            const data = [];
            snap.forEach(child => data.push(child.val()));
            data.sort((a,b)=>a.avgTime-b.avgTime);
            renderFirebaseLeaderboard(data);
        });
    }
    function renderFirebaseLeaderboard(rows){
        if(!rows || rows.length===0){ return; }
        // Replace existing list content with Firebase results (prefer Firebase over local)
        leaderboardList.innerHTML = '';
        rows.forEach((score,index)=>{
            const li=document.createElement('li');
            li.className='leaderboard-item rank-'+(index+1);
            li.innerHTML=`<div style="display:flex; align-items:center;"><span class="rank-num">${index+1}.</span><span class="rank-time">${score.avgTime} ms</span></div><span class="rank-date">${formatDateTime(score.timestamp)}</span>`;
            leaderboardList.appendChild(li);
        });
    }
    // Override save to also push to Firebase
    function pushFirebaseRecord(avg){
        if(!firebaseInitialized || !firebaseDatabase) return;
        import('https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js').then(dbModule => {
            const { ref, push, set } = dbModule;
            try {
                const scoresRef = ref(firebaseDatabase,'reactionScores');
                const newRef = push(scoresRef);
                const name = (document.getElementById('player-name').value || 'åŒ¿å').trim();
                const penalties = reactionTimes.filter(t=>t===1000).length;
                set(newRef, { avgTime: avg, timestamp: Date.now(), name, rounds: reactionTimes, penalties });
            } catch(err){ console.warn('Firebase save failed', err); }
        });
    }
    // Wrap original saveAndUpdateLeaderboard to include firebase push
    const originalSave = saveAndUpdateLeaderboard;
    function saveAndUpdateLeaderboard(){
        originalSave();
        const { avg } = calculateTrimmedScore(reactionTimes);
        pushFirebaseRecord(avg);
    }
    // Save button manual save (in case user wants after review)
    document.getElementById('save-last').addEventListener('click', ()=>{
        const { avg } = calculateTrimmedScore(reactionTimes);
        pushFirebaseRecord(avg);
        document.getElementById('save-last').disabled = true;
        document.getElementById('save-last').textContent = 'å·²ä¿å­˜';
    });
    initFirebase();
    init();
</script>
</body>
</html>
